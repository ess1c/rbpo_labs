<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title th:text="${listing.title}">–û–±—ä—è–≤–ª–µ–Ω–∏–µ</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }
        .back-link:hover {
            color: #764ba2;
        }
        .listing-detail {
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .listing-title {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #333;
        }
        .listing-price {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 25px;
        }
        .listing-description {
            color: #333;
            line-height: 1.8;
            margin-bottom: 30px;
            font-size: 16px;
        }
        .listing-meta {
            font-size: 14px;
            color: #666;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #f0f0f0;
        }
        .listing-meta p {
            margin-bottom: 10px;
        }
        .listing-actions {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn-danger:hover {
            background: #c82333;
        }
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        .status-badge {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        .status-active {
            background: #d4edda;
            color: #155724;
        }
        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .chat-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        .chat-header h2 {
            font-size: 20px;
            color: #333;
        }
        .btn-close {
            background: none;
            border: none;
            font-size: 28px;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            line-height: 30px;
        }
        .btn-close:hover {
            color: #333;
        }
        .chat-messages {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
        }
        .message {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 8px;
            background: white;
        }
        .message.sent {
            background: #e3f2fd;
            margin-left: 20%;
        }
        .message.received {
            background: #f5f5f5;
            margin-right: 20%;
        }
        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 12px;
            color: #666;
        }
        .message-text {
            color: #333;
            line-height: 1.5;
        }
        .chat-input-container {
            display: flex;
            gap: 10px;
        }
        .chat-input-container textarea {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            resize: vertical;
            font-family: inherit;
        }
        .chat-input-container textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        .chat-loading {
            text-align: center;
            color: #999;
            padding: 20px;
        }
        .chat-empty {
            text-align: center;
            color: #999;
            padding: 40px;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 2px solid #f0f0f0;
        }
        .modal-header h2 {
            font-size: 20px;
            color: #333;
        }
        .modal-body {
            padding: 20px;
        }
        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            resize: vertical;
            font-family: inherit;
        }
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
    </style>
</head>
<body>
<div class="container">
    <a href="/" class="back-link">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>

    <div id="alert-container"></div>

    <div class="listing-detail">
        <span class="status-badge" th:classappend="${listing.isActive} ? 'status-active' : 'status-inactive'"
              th:text="${listing.isActive ? '–ê–∫—Ç–∏–≤–Ω–æ' : '–ù–µ–∞–∫—Ç–∏–≤–Ω–æ'}"></span>
        <div class="listing-title" th:text="${listing.title}"></div>
        <div class="listing-price" th:text="${'‚ÇΩ' + #numbers.formatDecimal(listing.price, 0, 'COMMA', 2, 'POINT')}"></div>
        <div class="listing-description" th:text="${listing.description}"></div>
        <div class="listing-meta">
            <p><strong>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</strong> <span th:text="${listing.category.name}"></span></p>
            <p><strong>–ê–≤—Ç–æ—Ä:</strong> <span th:text="${listing.user.username}"></span></p>
            <p><strong>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:</strong> <span th:text="${#temporals.format(listing.createdAt, 'dd.MM.yyyy HH:mm')}"></span></p>
            <p th:if="${listing.updatedAt != null}"><strong>–û–±–Ω–æ–≤–ª–µ–Ω–æ:</strong> <span th:text="${#temporals.format(listing.updatedAt, 'dd.MM.yyyy HH:mm')}"></span></p>
        </div>
    </div>

    <div class="listing-actions" id="actionsContainer" style="display: none;">
        <a th:href="@{/listings/{id}/edit(id=${listing.id})}" class="btn btn-primary">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
        <button onclick="deleteListing()" class="btn btn-danger">–£–¥–∞–ª–∏—Ç—å</button>
        <button onclick="deactivateListing()" class="btn btn-secondary" th:if="${listing.isActive}">–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>

    <!-- –ß–∞—Ç -->
    <div id="chatSection" class="chat-section" style="display: none;">
        <div class="chat-header">
            <h2>–ü–µ—Ä–µ–ø–∏—Å–∫–∞ –ø–æ –æ–±—ä—è–≤–ª–µ–Ω–∏—é</h2>
            <button onclick="toggleChat()" class="btn-close">√ó</button>
        </div>
        <div id="chatMessages" class="chat-messages">
            <div class="chat-loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</div>
        </div>
        <div class="chat-input-container">
            <textarea id="messageText" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." rows="3"></textarea>
            <button onclick="sendMessage()" class="btn btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∏ –¥–ª—è —á–∞—Ç–∞ –∏ –∂–∞–ª–æ–±—ã -->
    <div class="listing-actions" id="userActionsContainer" style="display: none; margin-top: 20px;">
        <button onclick="toggleChat()" class="btn btn-primary">üí¨ –ù–∞–ø–∏—Å–∞—Ç—å –ø—Ä–æ–¥–∞–≤—Ü—É</button>
        <button onclick="showReportModal()" class="btn btn-danger">‚ö†Ô∏è –ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è</button>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∂–∞–ª–æ–±—ã -->
    <div id="reportModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è –Ω–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</h2>
                <button onclick="closeReportModal()" class="btn-close">√ó</button>
            </div>
            <div class="modal-body">
                <form id="reportForm">
                    <div class="form-group">
                        <label for="reportReason">–ü—Ä–∏—á–∏–Ω–∞ –∂–∞–ª–æ–±—ã *</label>
                        <textarea id="reportReason" name="reason" required rows="5" placeholder="–û–ø–∏—à–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –∂–∞–ª–æ–±—ã..."></textarea>
                    </div>
                    <div class="modal-actions">
                        <button type="button" onclick="closeReportModal()" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</button>
                        <button type="submit" class="btn btn-danger">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∂–∞–ª–æ–±—É</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// –ü–æ–ª—É—á–∞–µ–º ID –æ–±—ä—è–≤–ª–µ–Ω–∏—è –∏–∑ Thymeleaf
let listingId = null;
let listingUserId = null;

// –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ Thymeleaf
try {
    listingId = /*[[${listing.id}]]*/ null;
    listingUserId = /*[[${listing.user.id}]]*/ null;
} catch (e) {
    console.error('Error getting listing ID from Thymeleaf:', e);
}

// –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å, –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–∑ URL
if (!listingId || listingId === 0) {
    const pathParts = window.location.pathname.split('/');
    const idFromPath = parseInt(pathParts[pathParts.length - 1]);
    if (!isNaN(idFromPath) && idFromPath > 0) {
        listingId = idFromPath;
        console.log('Got listing ID from URL:', listingId);
    }
}

function getAuthHeaders() {
    const token = localStorage.getItem('accessToken');
    const headers = {};
    if (token) {
        headers['Authorization'] = `Bearer ${token}`;
    }
    return headers;
}

// –ï—Å–ª–∏ listingUserId –Ω–µ –ø–æ–ª—É—á–µ–Ω, –ø—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ API
async function loadListingUserId() {
    if ((!listingUserId || listingUserId === 0) && listingId) {
        try {
            const response = await fetch(`/api/listings/${listingId}`, {
                headers: getAuthHeaders(),
                credentials: 'include'
            });
            
            if (response.ok) {
                const listing = await response.json();
                if (listing && listing.user && listing.user.id) {
                    listingUserId = listing.user.id;
                    console.log('Got listing user ID from API:', listingUserId);
                    return true;
                }
            }
        } catch (error) {
            console.error('Error loading listing user ID:', error);
        }
    }
    return listingUserId && listingUserId !== 0;
}

// –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ ID –ø–æ–ª—É—á–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ
if (!listingId || listingId === 0) {
    console.error('Listing ID not found! Current value:', listingId);
}

let currentUserId = null;
let chatOpen = false;

async function checkOwnership() {
    try {
        // –°–Ω–∞—á–∞–ª–∞ —É–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ listingUserId –∑–∞–≥—Ä—É–∂–µ–Ω
        const listingLoaded = await loadListingUserId();
        if (!listingLoaded) {
            console.warn('Listing user ID not available yet, retrying...');
            setTimeout(checkOwnership, 500);
            return;
        }
        
        const response = await fetch('/api/users/me', {
            headers: getAuthHeaders(),
            credentials: 'include'
        });
        
        if (response.ok) {
            const user = await response.json();
            currentUserId = user.id;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ ID –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã
            if (!currentUserId) {
                console.error('Current user ID not found');
                return;
            }
            
            if (!listingUserId || listingUserId === 0) {
                console.error('Listing user ID not found:', listingUserId);
                return;
            }
            
            if (user.id === listingUserId) {
                // –í–ª–∞–¥–µ–ª–µ—Ü - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ —á–∞—Ç
                document.getElementById('actionsContainer').style.display = 'flex';
                document.getElementById('userActionsContainer').style.display = 'flex';
                // –ú–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞ –∏ —Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∂–∞–ª–æ–±—ã
                const chatBtn = document.querySelector('#userActionsContainer .btn-primary');
                if (chatBtn) chatBtn.textContent = 'üí¨ –ü–µ—Ä–µ–ø–∏—Å–∫–∞';
                const reportBtn = document.getElementById('reportBtn');
                if (reportBtn) reportBtn.style.display = 'none';
            } else {
                // –ù–µ –≤–ª–∞–¥–µ–ª–µ—Ü - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–Ω–æ–ø–∫–∏ –¥–ª—è —á–∞—Ç–∞ –∏ –∂–∞–ª–æ–±—ã
                document.getElementById('userActionsContainer').style.display = 'flex';
            }
        }
    } catch (error) {
        console.error('Error checking ownership:', error);
    }
}

function toggleChat() {
    chatOpen = !chatOpen;
    const chatSection = document.getElementById('chatSection');
    
    if (chatOpen) {
        chatSection.style.display = 'block';
        loadMessages();
    } else {
        chatSection.style.display = 'none';
    }
}

async function loadMessages() {
    const messagesContainer = document.getElementById('chatMessages');
    messagesContainer.innerHTML = '<div class="chat-loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</div>';
    
    try {
        const response = await fetch(`/api/messages/listing/${listingId}/conversation`, {
            headers: getAuthHeaders(),
            credentials: 'include'
        });
        
        if (response.ok) {
            const messages = await response.json();
            displayMessages(messages);
        } else {
            messagesContainer.innerHTML = '<div class="chat-empty">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
        }
    } catch (error) {
        console.error('Error loading messages:', error);
        messagesContainer.innerHTML = '<div class="chat-empty">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
    }
}

function displayMessages(messages) {
    const messagesContainer = document.getElementById('chatMessages');
    
    if (!messages || messages.length === 0) {
        messagesContainer.innerHTML = '<div class="chat-empty">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π. –ù–∞—á–Ω–∏—Ç–µ –ø–µ—Ä–µ–ø–∏—Å–∫—É!</div>';
        return;
    }
    
    messagesContainer.innerHTML = messages.map(msg => {
        const isSent = msg.sender && msg.sender.id === currentUserId;
        const senderName = msg.sender ? msg.sender.username : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
        const date = new Date(msg.createdAt).toLocaleString('ru-RU');
        
        return `
            <div class="message ${isSent ? 'sent' : 'received'}">
                <div class="message-header">
                    <span><strong>${escapeHtml(senderName)}</strong></span>
                    <span>${date}</span>
                </div>
                <div class="message-text">${escapeHtml(msg.text)}</div>
            </div>
        `;
    }).join('');
    
    // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

async function sendMessage() {
    const text = document.getElementById('messageText').value.trim();
    
    if (!text) {
        showAlert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è', 'error');
        return;
    }
    
    if (!listingId || listingId === 0) {
        showAlert('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ', 'error');
        return;
    }
    
    if (!currentUserId) {
        showAlert('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
        return;
    }
    
    if (!listingUserId || listingUserId === 0) {
        showAlert('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–ª–∞–¥–µ–ª—å—Ü–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏—è', 'error');
        return;
    }
    
    try {
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–ª—É—á–∞—Ç–µ–ª—è: –µ—Å–ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –≤–ª–∞–¥–µ–ª–µ—Ü, —Ç–æ –ø–æ–ª—É—á–∞—Ç–µ–ª—å - –¥—Ä—É–≥–æ–π —É—á–∞—Å—Ç–Ω–∏–∫ –ø–µ—Ä–µ–ø–∏—Å–∫–∏
        // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –Ω–µ –≤–ª–∞–¥–µ–ª–µ—Ü, —Ç–æ –ø–æ–ª—É—á–∞—Ç–µ–ª—å - –≤–ª–∞–¥–µ–ª–µ—Ü
        let receiverId = null;
        
        // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –≤–ª–∞–¥–µ–ª–µ—Ü, –Ω—É–∂–Ω–æ –Ω–∞–π—Ç–∏ –¥—Ä—É–≥–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –ø–µ—Ä–µ–ø–∏—Å–∫–∏
        if (currentUserId === listingUserId) {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–ø–∏—Å–∫—É, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –¥—Ä—É–≥–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞
            const convResponse = await fetch(`/api/messages/listing/${listingId}/conversation`, {
                headers: getAuthHeaders(),
                credentials: 'include'
            });
            
            if (convResponse.ok) {
                const messages = await convResponse.json();
                if (messages && messages.length > 0) {
                    // –ù–∞—Ö–æ–¥–∏–º –¥—Ä—É–≥–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –ø–µ—Ä–µ–ø–∏—Å–∫–∏ (–Ω–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è, –∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—è
                    let otherUser = null;
                    for (const msg of messages) {
                        if (msg.sender && msg.sender.id && msg.sender.id !== currentUserId) {
                            otherUser = msg.sender;
                            break;
                        }
                        if (msg.receiver && msg.receiver.id && msg.receiver.id !== currentUserId) {
                            otherUser = msg.receiver;
                            break;
                        }
                    }
                    
                    if (otherUser && otherUser.id) {
                        receiverId = otherUser.id;
                    } else {
                        showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—É—á–∞—Ç–µ–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è', 'error');
                        return;
                    }
                } else {
                    // –ï—Å–ª–∏ –ø–µ—Ä–µ–ø–∏—Å–∫–∏ –Ω–µ—Ç, –Ω–µ–ª—å–∑—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ (–≤–ª–∞–¥–µ–ª–µ—Ü –Ω–µ –º–æ–∂–µ—Ç –Ω–∞—á–∞—Ç—å –ø–µ—Ä–µ–ø–∏—Å–∫—É)
                    showAlert('–ù–µ—Ç –ø–µ—Ä–µ–ø–∏—Å–∫–∏. –î–æ–∂–¥–∏—Ç–µ—Å—å —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ø–æ–∫—É–ø–∞—Ç–µ–ª—è.', 'error');
                    return;
                }
            } else {
                showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–µ—Ä–µ–ø–∏—Å–∫–∏', 'error');
                return;
            }
        } else {
            // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –Ω–µ –≤–ª–∞–¥–µ–ª–µ—Ü, –ø–æ–ª—É—á–∞—Ç–µ–ª—å - –≤–ª–∞–¥–µ–ª–µ—Ü
            receiverId = listingUserId;
        }
        
        // –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –Ω–µ–ª—å–∑—è –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–∞–º–æ–º—É —Å–µ–±–µ
        if (!receiverId || receiverId === 0 || receiverId === currentUserId) {
            showAlert('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—É—á–∞—Ç–µ–ª—è –∏–ª–∏ –ø–æ–ø—ã—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–∞–º–æ–º—É —Å–µ–±–µ', 'error');
            return;
        }
        
        const headers = getAuthHeaders();
        headers['Content-Type'] = 'application/json';
        
        const response = await fetch('/api/messages', {
            method: 'POST',
            headers: headers,
            credentials: 'include',
            body: JSON.stringify({
                text: text,
                listingId: listingId,
                receiverId: receiverId
            })
        });
        
        if (response.ok) {
            document.getElementById('messageText').value = '';
            loadMessages();
        } else {
            const error = await response.json();
            showAlert('–û—à–∏–±–∫–∞: ' + (error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ'), 'error');
        }
    } catch (error) {
        console.error('Error sending message:', error);
        showAlert('–û—à–∏–±–∫–∞: ' + error.message, 'error');
    }
}

function showReportModal() {
    document.getElementById('reportModal').style.display = 'flex';
}

function closeReportModal() {
    document.getElementById('reportModal').style.display = 'none';
    document.getElementById('reportForm').reset();
}

document.getElementById('reportForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const reason = document.getElementById('reportReason').value.trim();
    
    if (!reason) {
        showAlert('–í–≤–µ–¥–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –∂–∞–ª–æ–±—ã', 'error');
        return;
    }
    
    try {
        const headers = getAuthHeaders();
        headers['Content-Type'] = 'application/json';
        
        const response = await fetch('/api/reports', {
            method: 'POST',
            headers: headers,
            credentials: 'include',
            body: JSON.stringify({
                reason: reason,
                listingId: listingId
            })
        });
        
        if (response.ok) {
            showAlert('–ñ–∞–ª–æ–±–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!', 'success');
            closeReportModal();
        } else {
            const error = await response.json();
            showAlert('–û—à–∏–±–∫–∞: ' + (error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∂–∞–ª–æ–±—É'), 'error');
        }
    } catch (error) {
        showAlert('–û—à–∏–±–∫–∞: ' + error.message, 'error');
    }
});

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ Enter (Ctrl+Enter)
document.getElementById('messageText')?.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && e.ctrlKey) {
        sendMessage();
    }
});

async function deleteListing() {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ?')) {
        return;
    }

    try {
        const response = await fetch('/api/listings/' + listingId, {
            method: 'DELETE',
            headers: getAuthHeaders(),
            credentials: 'include'
        });

        if (response.ok || response.status === 204) {
            showAlert('–û–±—ä—è–≤–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ!', 'success');
            setTimeout(() => {
                window.location.href = '/';
            }, 1500);
        } else {
            const error = await response.json();
            showAlert('–û—à–∏–±–∫–∞: ' + (error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ'), 'error');
        }
    } catch (error) {
        showAlert('–û—à–∏–±–∫–∞: ' + error.message, 'error');
    }
}

async function deactivateListing() {
    try {
        const response = await fetch('/api/listings/' + listingId + '/deactivate', {
            method: 'POST',
            headers: getAuthHeaders(),
            credentials: 'include'
        });

        if (response.ok) {
            showAlert('–û–±—ä—è–≤–ª–µ–Ω–∏–µ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ!', 'success');
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            const error = await response.json();
            showAlert('–û—à–∏–±–∫–∞: ' + (error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ'), 'error');
        }
    } catch (error) {
        showAlert('–û—à–∏–±–∫–∞: ' + error.message, 'error');
    }
}

function showAlert(message, type) {
    const container = document.getElementById('alert-container');
    container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
    setTimeout(() => {
        container.innerHTML = '';
    }, 5000);
}

checkOwnership();
</script>
</body>
</html>


